version: 2.1
jobs:
    lint-html:
      docker:
        - image: amazon/aws-cli
      steps:
        - checkout
        - run:
            name: run html lint
            command: |
                rpm -i tidy-5.4.0-64bit.rpm
                tidy -q -e index.html
            
    lint-docker:
      docker: 
        - image: python:3.7.3-stretch
      steps:
        - checkout
        - run:
            name: install dependencies
            command: |
                # Install hadolint
                pwd
                wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64 &&\
                chmod +x hadolint
        - run:
            name: run lint
            command: |
                    pwd
                    make lint    
                    
    build-push-docker-image:
      docker:
        - image: circleci/golang:1.15
          auth:
            username: $DOCKERHUB_USER
            password: $DOCKERHUB_PWD  # context / project UI env-var reference
      steps:
        - checkout
        - setup_remote_docker:
            version: 19.03.13
        - run:
            name: build and push docker image
            command: |
                
                # Build image and add a descriptive tag
                docker build --tag=capstone-project-demowebsite .
                
                # List docker images
                docker image ls
                
                # Run our static website
                #docker run -it --rm -d -p 8080:80 --name web capstone-project-demowebsite
                #dockerpath=shikhas/capstone-project-demowebsite
                
                #Login to docker hub
                docker login --username $DOCKERHUB_USER --password $DOCKERHUB_PWD

                docker tag capstone-project-demowebsite shikhas/capstone-project-demowebsite
                docker push shikhas/capstone-project-demowebsite
                
    deploy-to-aws:
      docker:
        - image: amazon/aws-cli
      steps:
        - checkout
        - run:
            name: Installing kubectl
            command: |
                curl -o kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.18.16/2020-11-02/bin/linux/amd64/kubectl 
                chmod +x ./kubectl
                
                mkdir -p $HOME/bin && cp ./kubectl $HOME/bin/kubectl && export PATH=$PATH:$HOME/bin
                kubectl version --short --client
                
   
workflows:
  default:
    jobs:
      - lint-html
      - lint-docker:
          requires: [lint-html]
      - build-push-docker-image:
          requires: [lint-docker]
      - deploy-to-aws:
          requires: [build-push-docker-image]
